OPT_LVL = 
#OPT_LVL = -O3
#OPT_LVL = -Xptxas="-v"

ARCH = sm_20 
#ARCH = sm_35 

dxch_test_cuda: libmetamorph_cuda.so
	gcc dxch_bootstrapper.c $(OPT_LVL) -I ./ -D WITH_CUDA -D WITH_TIMERS -L ./ -L /usr/local/cuda/lib64 -lmetamorph_cuda -lmm_cuda_backend -o dxch_test_cuda

red_test_cuda: libmetamorph_cuda.so
	gcc red_bootstrapper.c $(OPT_LVL) -I ./ -D WITH_CUDA -D WITH_TIMERS -L ./ -L /usr/local/cuda/lib64 -lmetamorph_cuda -lmm_cuda_backend -o red_test_cuda

libmetamorph_cuda.so: libmm_cuda_backend.so metamorph.c
	gcc metamorph.c metamorph_timers.c $(OPT_LVL) -fPIC -shared -D WITH_CUDA -D WITH_TIMERS -I ./ -L ./ -L /usr/local/cuda/lib64 -lmm_cuda_backend -lcudart -o libmetamorph_cuda.so

libmm_cuda_backend.so:
	nvcc mm_cuda_backend.cu $(OPT_LVL) -Xcompiler -fPIC -shared -I ./ -L /usr/local/cuda/lib64 -lcudart  -o libmm_cuda_backend.so -D __CUDACC__ -arch $(ARCH)

red_test_cuda_DEBUG: libmetamorph_cuda_DEBUG.so
	gcc red_bootstrapper.c -I ./ -D WITH_CUDA -D WITH_OPENMP -D WITH_TIMERS -L ./ -L /usr/local/cuda/lib64 -lmetamorph_cuda_DEBUG -lmm_cuda_backend_DEBUG -o red_test_cuda_DEBUG -g -O0

libmetamorph_cuda_DEBUG.so: libmm_cuda_backend_DEBUG.so metamorph.c
	gcc metamorph.c metamorph_timers.c -fPIC -shared -D WITH_CUDA -D WITH_TIMERS -I ./ -L ./ -L /usr/local/cuda/lib64 -lmm_cuda_backend_DEBUG -lcudart -o libmetamorph_cuda_DEBUG.so -g -O0

libmm_cuda_backend_DEBUG.so:
	nvcc mm_cuda_backend.cu -Xcompiler -fPIC -shared -I ./ -L /usr/local/cuda/lib64 -lcudart  -o libmm_cuda_backend_DEBUG.so -D __CUDACC__ -arch $(ARCH) -g -O0

clean:
	rm libmetamorph*.so *.mod dxch_test_cuda xch_test red_test red_test_nocuda red_test_cuda red_test_omp red_test_notimers red_test_nocuda_notimers red_test_fortran red_test_fortran_nocuda red_test_fortran_notimers red_test_fortran_nocuda_notimers red_test_DEBUG red_test_nocuda_DEBUG red_test_cuda_DEBUG red_test_omp_DEBUG red_test_notimers_DEBUG red_test_nocuda_notimers_DEBUG red_test_fortran_DEBUG red_test_fortran_nocuda_DEBUG red_test_fortran_notimers_DEBUG red_test_fortran_nocuda_notimers_DEBUG
