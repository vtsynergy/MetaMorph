# WIP

# Installing MetaCL and MetaMorph

The MetaCL host-to-device interface generator for OpenCL makes use of MetaMorph's OpenCL backend and API for common support functions across applications. As such, installation and of MetaCL and MetaMorph are intertwined.

This tutorial walks through the typical steps of performing an **OpenCL-only** installation of MetaMorph on an Ubuntu 16.04 system without a pre-existing install of Clang. Variations to this environment will likely require tweaks to the instructions below. Where possible we have tried to declare what is specific to this environment to make that easier.

## Acquiring MetaCL and MetaMorph

The easiest way to acquire MetaCL and MetaMorph is via source code from GitHub. Simply clone it from there and change into the created directory
```BASH
git clone https://www.github.com/VTSynergy/MetaMorph && cd MetaMorph
```

## Getting oriented

Within the main MetaMorph directory you will several directories and a few logistics files. First and foremost please familiarize yourself with the [License](../../../../LICENSE) before proceeding further. The [Readme](../../../../Readme.md) provides more information on MetaMorph itself.

For developing OpenCL applications based on MetaCL, we only need to be concerned with the global [metamorph.h](../../../../include/metamorph.h) header, the [OpenCL backend](../../../../metamorph-backends/opencl-backend) and [OpenCL API header](../../../../metamorph-backends/opencl-backend/mm_opencl_backend.h), and the [MetaCL directory](../../../../metamorph-generators/opencl). For more internal information about these components, please consult the doxygen generated by the `docs` make target.

## Preparing to build MetaMorph and MetaCL from source
MetaMorph and MetaCL use a purely Makefile-based build system that makes use of variables for configuration. 
Additionally, the MetaCL portion of the system currently presumes there is no implementation of its Clang dependency on the system yet, and that the pre-compiled binaries for Ubuntu 16.04 will be compatible with the execution environment. This presumption will eventually be relaxed, but for now you may try the proposed workarounds for alternative environments below.


#### Alternative operating systems
If your execution environment is not Ubuntu 16.04, the [LLVM releases download page](http://releases.llvm.org/download.html) provides pre-built binary installations for several operating systems. If you also do not have a version of Clang that is compatible with MetaCL already installed on your system, then one of these may be the easiest route to installation. You will need to modify the `LLVM_OS_STRING` variable of the [MetaCL 
Makefile](../../Makefile) to reflect your operating system. If a pre-built binary is not available for your operating system, you may need to compile Clang from source. This is a lengthy but not difficult process, which is outside the scope of the MetaCL tutorial, but more information can be found [here](http://llvm.org/docs/GettingStarted.html#getting-started-with-llvm).

#### Alternative clang installs
As a _[Clang Tool](https://clang.llvm.org/docs/LibTooling.html)_, MetaCL should be compatible with any Clang 
installation that provides all the libraries listed in the `CLANG_LIBS` variable of the [MetaCL 
Makefile](../../Makefile), but has been designed for Clang 6.0 or newer. You may prevent the MetaCL Makefile from trying to download an additional version 
of Clang by modifying the `LLVM_BUILD_PATH` variable to point to the directory that contains the existing 
Clang installation's `bin`, `include`, and `lib` directories. _In the [How to use MetaCL](./GenerateMetaCLInterface.md) tutorial this alternative path will likely need to be substituted when providing the Clang include directory to the MetaCL invocation with `-I <path to Clang's implementation of opencl-c.h>`_

##### TODO: Test minimum useable Clang version

## Building MetaMorph and MetaCL from source
For the purposes of this tutorial we will configure MetaMorph to contain only the OpenCL backend, as it is required by MetaCL-generated modules, and MetaCL does not provide any CUDA or OpenMP capabilities. We will also disable the timing and MPI APIs, which are currently only designed for use with the builtin kernels. To do this, we will launch `make` with additional arguments, these are:
* `USE_OPENMP=false` (disable OpenMP functionality in MetaMorph)
* `USE_CUDA=false` (disable CUDA functionality in MetaMorph)
* `USE_OPENCL=true` (force OpenCL functionality in MetaMorph)
* `USE_TIMERS=false` (disable timing of certain MetaMorph API functions)
* `USE_MPI=false` (disable generation of certain transparent MPI features in MetaMorph)
(MetaCL will happily interoperate with any installation of MetaMorph that includes the OpenCL backend. It does not have to be compiled to exclusively OpenCL, but MetaCL will not generate wrappers for either the CUDA or OpenMP backends.)


With this configuration, MetaMorph will require an OpenCL installation exists on the system and is discoverable. (Specifically it requires a `libOpenCL.so` and `CL/cl.h` exist.) If these cannot be found or you wish to compile it to a specific implementation you may provide that via the following variables:
* `OPENCL_LIB_DIR=<absolute path>` (directory containing `libOpenCL.so`)
* `OPENCL_INCL_DIR=<absolute path>` (The directory that contains `CL/cl.h`)

Then, to build MetaMorph you simply invoke make on the `all` target with the variables specified above.
```BASH
USE_OPENMP=false USE_CUDA=false USE_OPENCL=true USE_TIMERS=false USE_MPI=false make all
```

And to build MetaCL you just invoke make on the `generators` target.
```BASH
make generators
```

## After completion
After successful invocations of both make commands, MetaMorph and MetaCL are both now compiled and ready for use. Make note of the following locations for use in subsequent tutorials.

The `metaCL` binary should be found within the [metamorph-generators/opencl](../..) directory and is discussed further in [How to use MetaCL](./GenerateMetaCLInterface.md).

The MetaMorph libraries that the MetaCL-generated interface will need (`libmetamorph.so` and `libmm_opencl_backend.so`) are contained in the [lib](../../../../lib) directory. These will be necessary when modifying your application's build system to incorporate the new interface, discussed in [MetaCL-izing an Existing Application](./ExistingApplication.md).